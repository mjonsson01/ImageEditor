<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fixed Crop ML Dataset Editor</title>

<style>
body {
    font-family: system-ui, sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#dropZone {
    width: 720px;
    height: 520px;
    border: 2px dashed #999;
    background: white;
    position: relative;
    overflow: hidden;
    user-select: none;
}

#dropHint {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #777;
    pointer-events: none;
}

canvas {
    position: absolute;
    inset: 0;
    cursor: grab;
}

canvas:active {
    cursor: grabbing;
}

#cropFrame {
    position: absolute;
    border: 2px solid red;
    pointer-events: none;
}

.controls {
    display: flex;
    gap: 12px;
    margin-top: 10px;
}
</style>
</head>

<body>

<h2>Fixed Crop ML Dataset Editor</h2>

<div id="dropZone">
    <div id="dropHint">Drop image or click to load</div>
    <input type="file" id="fileInput" accept="image/*" hidden>
    <canvas id="canvas"></canvas>
    <div id="cropFrame"></div>
</div>

<div class="controls">
    <label>Crop W <input id="cropW" type="number" value="256"></label>
    <label>Crop H <input id="cropH" type="number" value="256"></label>
    <label>Border <input id="border" type="number" value="0"></label>
    <label>Filename
        <input id="filename" type="text" value="ml_crop">
    </label>
    <button id="exportBtn">Export JPG</button>
    <button id="clearBtn" type="button">Clear Image</button>
</div>

<script>
const filenameInput = document.getElementById("filename");
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const exportBtn = document.getElementById("exportBtn");
const clearBtn = document.getElementById("clearBtn");
const cropFrame = document.getElementById("cropFrame");
const dropHint = document.getElementById("dropHint");

let img = new Image();
let hasImage = false;

let scale = 1;
let offsetX = 0;
let offsetY = 0;

let dragging = false;
let lastX, lastY;

function resizeCanvas() {
    canvas.width = dropZone.clientWidth;
    canvas.height = dropZone.clientHeight;
}

resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function updateCropFrame() {
    const w = +cropW.value;
    const h = +cropH.value;
    cropFrame.style.width = w + "px";
    cropFrame.style.height = h + "px";
    cropFrame.style.left = (canvas.width - w) / 2 + "px";
    cropFrame.style.top = (canvas.height - h) / 2 + "px";
}

cropW.oninput = cropH.oninput = updateCropFrame;
updateCropFrame();

/* ---------- File Loading ---------- */

dropZone.addEventListener("click", e => {
    if (!hasImage) fileInput.click();
});

dropZone.addEventListener("dragover", e => e.preventDefault());
dropZone.addEventListener("drop", e => {
    e.preventDefault();
    loadFile(e.dataTransfer.files[0]);
});

fileInput.onchange = e => loadFile(e.target.files[0]);

function loadFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        img.onload = () => {
            hasImage = true;
            dropHint.style.display = "none";

            scale = Math.min(
                canvas.width / img.width,
                canvas.height / img.height
            );

            offsetX = (canvas.width - img.width * scale) / 2;
            offsetY = (canvas.height - img.height * scale) / 2;

            draw();
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(file);
}

/* ---------- Rendering ---------- */

function draw() {
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(
        img,
        offsetX,
        offsetY,
        img.width * scale,
        img.height * scale
    );
}

/* ---------- Pan / Zoom ---------- */

canvas.addEventListener("mousedown", e => {
    if (!hasImage) return;
    dragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
    e.stopPropagation();
});

window.addEventListener("mouseup", () => dragging = false);

window.addEventListener("mousemove", e => {
    if (!dragging) return;
    offsetX += e.clientX - lastX;
    offsetY += e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;
    draw();
});

canvas.addEventListener("wheel", e => {
    if (!hasImage) return;
    e.preventDefault();

    const zoom = e.deltaY < 0 ? 1.1 : 0.9;
    scale *= zoom;
    draw();
});

/* ---------- Export ---------- */

exportBtn.onclick = () => {
    if (!hasImage) return;

    const cropWv = +cropW.value;
    const cropHv = +cropH.value;
    const borderPx = +document.getElementById("border").value;

    const frameX = (canvas.width - cropWv) / 2;
    const frameY = (canvas.height - cropHv) / 2;

    let srcX = (frameX - offsetX) / scale;
    let srcY = (frameY - offsetY) / scale;
    let srcW = cropWv / scale;
    let srcH = cropHv / scale;

    // Clamp to image bounds (CRITICAL)
    srcX = Math.max(0, Math.min(img.width - srcW, srcX));
    srcY = Math.max(0, Math.min(img.height - srcH, srcY));

    const out = document.createElement("canvas");
    const outW = Math.round(srcW);
    const outH = Math.round(srcH);

    out.width = outW + borderPx * 2;
    out.height = outH + borderPx * 2;


    const octx = out.getContext("2d");
    octx.fillStyle = "black";
    octx.fillRect(0, 0, out.width, out.height);

    octx.drawImage(
        img,
        srcX, srcY, srcW, srcH,
        borderPx, borderPx, outW, outH
    );

    out.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        let name = filenameInput.value.trim() || "ml_crop";
        // Remove illegal characters (dataset-safe)
        name = name.replace(/[^a-z0-9_\-]/gi, "_");
        // Ensure .jpg extension
        if (!name.toLowerCase().endsWith(".jpg")) {
            name += ".jpg";
        }
        a.download = name;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, "image/jpeg", 0.95);
};

/* Clear button */
function clearImage() {
    hasImage = false;
    img.src = "";
    scale = 1;
    offsetX = 0;
    offsetY = 0;

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    dropHint.style.display = "flex";
}
clearBtn.onclick = () => {
    clearImage();
};
</script>

</body>
</html>
